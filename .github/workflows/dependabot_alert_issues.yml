name: Dependabot high/critical alert issues

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  issues: write
  contents: read
  pull-requests: read

jobs:
  create_issue_for_high_critical:
    runs-on: ubuntu-latest

    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create tracking issue for high/critical advisory
        if: |
          steps.metadata.outputs.security-advisory-severity == 'high' ||
          steps.metadata.outputs.security-advisory-severity == 'critical'
        uses: actions/github-script@v7
        env:
          SEVERITY: ${{ steps.metadata.outputs.security-advisory-severity }}
          GHSA: ${{ steps.metadata.outputs.security-advisory-ghsa-id }}
          PACKAGE: ${{ steps.metadata.outputs.dependency-names }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            const severity = (process.env.SEVERITY || 'unknown').toUpperCase();
            const pkg = process.env.PACKAGE || 'unknown-package';
            const ghsa = process.env.GHSA || 'unknown-GHSA';
            const alertUrl = pr.html_url; // link to PR as the "alert" surface

            const teamMention = '@Dopeamin';

            const title = `[Dependabot] ${severity} vulnerability in ${pkg} (${ghsa})`;

            // Avoid duplicates: search by GHSA id in title
            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} "${ghsa}" in:title is:issue`,
            });

            if (search.data.total_count > 0) {
              console.log('Issue already exists for this advisory, skipping.');
              return;
            }

            const body = `${teamMention}

            A new **${severity}** Dependabot alert was detected.

            - **Package**: \`${pkg}\`
            - **Advisory (GHSA)**: \`${ghsa}\`
            - **Alert URL**: ${alertUrl}

            This issue was created automatically by a GitHub Actions workflow.`;

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['security', 'dependabot', severity.toLowerCase()],
              
              assignees: ['Dopeamin'],
            });
