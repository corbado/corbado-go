name: Dependabot high/critical alert issues

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  issues: write
  contents: write # was: read  -> needed for merging
  pull-requests: write # was: read  -> needed for merging
  checks: read
  statuses: read

jobs:
  create_issue_for_high_critical:
    runs-on: ubuntu-latest

    if: github.event.pull_request.user.login == 'dependabot[bot]'

    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create tracking issue for advisory
        uses: actions/github-script@v7
        env:
          GHSA: ${{ steps.metadata.outputs.ghsa-id }}
          PACKAGE: ${{ steps.metadata.outputs.dependency-names }}
          PREVIOUS_VERSION: ${{ steps.metadata.outputs.previous-version }}
          NEW_VERSION: ${{ steps.metadata.outputs.new-version }}
          UPDATE_TYPE: ${{ steps.metadata.outputs.update-type }}
          DEPENDENCY_TYPE: ${{ steps.metadata.outputs.dependency-type }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            const pkg = process.env.PACKAGE || 'unknown-package';
            const ghsa = process.env.GHSA || '';
            const previousVersion = process.env.PREVIOUS_VERSION || 'unknown';
            const newVersion = process.env.NEW_VERSION || 'unknown';
            const updateType = process.env.UPDATE_TYPE || 'unknown';
            const dependencyType = process.env.DEPENDENCY_TYPE || 'unknown';
            const alertUrl = pr.html_url; // link to PR as the "alert" surface

            const teamMention = '@Dopeamin';

            const title = ghsa
              ? `[Dependabot] Advisory for ${pkg} (${ghsa})`
              : `[Dependabot] Update for ${pkg} (${previousVersion} → ${newVersion})`;

            // Avoid duplicates: search by GHSA id or package/version in title
            const duplicateQuery = ghsa
              ? `repo:${owner}/${repo} "${ghsa}" in:title is:issue`
              : `repo:${owner}/${repo} "${pkg}" "${newVersion}" in:title is:issue`;
            const search = await github.rest.search.issuesAndPullRequests({
              q: duplicateQuery,
            });

            if (search.data.total_count > 0) {
              console.log('Issue already exists for this advisory, skipping.');
              return;
            }

            const details = [
              `- **Package**: \`${pkg}\``,
              `- **Update**: \`${previousVersion}\` → \`${newVersion}\``,
              `- **Update type**: ${updateType}`,
              `- **Dependency type**: ${dependencyType}`,
              `- **PR**: #${pr.number}`,
            ];

            if (ghsa) {
              details.splice(2, 0, `- **Advisory (GHSA)**: \`${ghsa}\``);
            }

            const body = `${teamMention}

            A new Dependabot pull request requires attention.

            ${details.join('\n')}

            This issue was created automatically by a GitHub Actions workflow.`;

            const labels = ['dependabot'];
            if (ghsa) {
              labels.push('security');
            }
            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels,
              assignees: ['Dopeamin'],
            });

  auto_merge_dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]' || contains(github.event.pull_request.labels.*.name, 'auto-merge-test')

    steps:
      - name: Check if all required checks passed
        id: status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const sha = pr.head.sha;

            // Combined status (old API)
            const { data: combined } = await github.rest.repos.getCombinedStatusForRef({
              owner,
              repo,
              ref: sha,
            });

            // Checks API (GitHub Actions and other checks)
            const { data: checks } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
            });

            const allStatusesSuccess =
              (combined.state === 'success' || combined.state === 'pending') &&
              combined.statuses.every(s =>
                ['success', 'neutral', 'skipped', 'pending'].includes(s.state)
              );

            const allChecksSuccess =
              checks.check_runs.length === 0 ||
              checks.check_runs.every(c =>
                ['success', 'neutral', 'skipped'].includes(c.conclusion)
              );

            if (!allStatusesSuccess || !allChecksSuccess) {
              core.info('Not all checks are successful yet – skipping merge.');
              core.setOutput('can_merge', 'false');
            } else {
              core.info('All checks look good – ready to merge.');
              core.setOutput('can_merge', 'true');
            }

      - name: Merge Dependabot PR
        if: steps.status.outputs.can_merge == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: pr.number,
              merge_method: 'squash', // or 'merge' / 'rebase'
            });

            core.info(`Merged Dependabot PR #${pr.number}`);
